function rgb(e,t,n){return"rgb("+e+","+t+","+n+")"}function rgb_darken(e,t,n,r){e=Math.floor(e*r);t=Math.floor(t*r);n=Math.floor(n*r);return rgb(e,t,n)}function initializeGameField(){for(var e=0;e<10;e++){gamefield[e]=[];binfield[e]=[];for(var t=0;t<20;t++){gamefield[e][t]="";binfield[e][t]=0}}}function leftPad(e,t){var n=e+"";while(n.length<t){n="0"+n}return n}function supports_html5_storage(){try{return"localStorage"in window&&window["localStorage"]!==null}catch(e){return false}}function hexToRgb(e){var t=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(e);return t?{r:parseInt(t[1],16),g:parseInt(t[2],16),b:parseInt(t[3],16)}:null}function drawScore(){strscore=leftPad(score,5);strspeed=leftPad(500-counter,3);var e=pixel_size*4+2*line_padding;ctx.lineWidth=line_padding*2;ctx.strokeStyle="gray";ctx.strokeRect(canvas_width-e-line_padding,line_padding,e,e);ctx.fillStyle="#323232";ctx.fillRect(canvas_width-e,2*line_padding,e-2*line_padding,e-2*line_padding);ctx.font=fontSize+"px VT323";ctx.fillStyle="white";var t=canvas_width-4.13*pixel_size;if(supports_html5_storage()){highscore=Number(localStorage.high);var n=leftPad(highscore,5);if(score>highscore){highscore=score;localStorage.high=highscore;n=leftPad(highscore,5);console.log(n)}ctx.fillText("Score: "+strscore,t,1.5*pixel_size);ctx.fillText("High : "+n,t,2.5*pixel_size);ctx.fillText("Speed: "+strspeed,t,3.5*pixel_size)}else{ctx.fillText("Score: "+strscore,t,1.5*pixel_size);ctx.fillText("Speed: "+strspeed,t,3*pixel_size)}}function drawDisplay(){var e=pixel_size*4+2*line_padding;ctx.lineWidth=line_padding*2;ctx.strokeStyle="gray";ctx.strokeRect(line_padding,line_padding,e,e);for(i=0;i<4;i++){for(j=0;j<4;j++){drawDisplayRect(i,j,"#323232",pixel_size,line_padding)}}ctx.font=fontSize+"px VT323";ctx.fillStyle="white";ctx.fillText("Up Next",1.33*pixel_size,2*line_padding+.6*pixel_size)}function drawGameField(e,t,n,r){ctx.lineWidth=r*2;ctx.strokeStyle="gray";ctx.strokeRect((e-t)/2-r,r,t+2*r,n+2*r)}function drawDisplayRect(e,t,n,r,i){var s=i*2+e*r;var o=i*2+t*r;var u=hexToRgb(n);ctx.fillStyle=rgb(u.r,u.g,u.b);ctx.fillRect(s,o,r,r);ctx.lineWidth=i;ctx.strokeStyle=rgb_darken(u.r,u.g,u.b,.92);ctx.strokeRect(s+i/2,o+i/2,r-i,r-i)}function pause(){if(ispaused){timerHelper=setTimeout(Timer,counter);$("#my_popup").popup("hide");ispaused=false}else{$("#my_popup").popup("show");clearTimeout(timerHelper);ispaused=true}}function drawDisplayTetromino(e,t){for(var n=0;n<4;n++){for(var r=0;r<4;r++){if(e[n][r]==1){drawDisplayRect(n,r,t,pixel_size,line_padding)}}}}function drawComponentSquare(e,t,n,r,i,s,o){var u=(i-s)/2+e*r;var a=2*o+t*r;var f=hexToRgb(n);ctx.fillStyle=rgb(f.r,f.g,f.b);ctx.fillRect(u,a,r,r);ctx.lineWidth=o;ctx.strokeStyle=rgb_darken(f.r,f.g,f.b,.92);ctx.strokeRect(u+o/2,a+o/2,r-o,r-o)}function placeTetromino(e,t,n){var r=0;for(var i=0;i<4;i++){for(var s=0;s<4;s++){xcoord=t+i-1;ycoord=n+s-1;xlegal=xcoord<=9&&xcoord>=0;ylegal=ycoord<=19&&ycoord>=0;if(!xlegal||!ylegal){if(e[i][s]==1){r++}}else if(binfield[xcoord][ycoord]==1&&e[i][s]==1){r++}}}if(r==0&&!ispaused){return true}else{return false}}function projectTetromino(e,t,n){var r=n;while(placeTetromino(e,t,r)){r++}drawTetromino(e,"#BEBEBE",t,r-1,pixel_size,canvas_width,gamefield_width,line_padding,true)}function drawTetromino(e,t,n,r,i,s,o,u,a){if(a){for(var f=0;f<4;f++){for(var l=0;l<4;l++){if(e[f][l]==1){drawComponentSquare(n+f-1,r+l-1,t,i,s,o,u)}}}}}function checkClear(){clearCount=0;for(j=0;j<20;j++){canClear=true;for(i=0;i<10;i++){if(canClear&&binfield[i][j]==1){continue}else{canClear=false}}if(canClear){clearCount++;for(i=0;i<10;i++){binfield[i][j]=0;gamefield[i][j]=""}for(k=j;k>0;k--){for(i=0;i<10;i++){binfield[i][k]=binfield[i][k-1];gamefield[i][k]=gamefield[i][k-1]}}}}score=score+clearCount*100;counter=Math.floor(500-Math.pow(score,.7))}function refresh(e,t,n,r){checkClear();drawScore();drawDisplay();drawDisplayTetromino(next_shape,next_color);drawGameField(canvas_width,gamefield_width,gamefield_height,line_padding);testGameField();if(!gameover){projectTetromino(n,e,t)}drawTetromino(n,r,e,t,pixel_size,canvas_width,gamefield_width,line_padding,placeTetromino(n,e,t))}function rotate(e,t){var n=[];for(var r=0;r<4;r++){n[r]=[];for(var i=0;i<4;i++){if(t==1){n[r][i]=e[i][3-r]}}}return n}function testGameField(){for(var e=0;e<10;e++){for(var t=0;t<20;t++){if(gamefield[e][t]==""){var n="#323232"}else{var n=gamefield[e][t]}drawComponentSquare(e,t,n,pixel_size,canvas_width,gamefield_width,line_padding)}}}function lockTile(e,t,n,r){for(i=0;i<4;i++){for(j=0;j<4;j++){if(n[i][j]==1){gamefield[e+i-1][t+j-1]=r;binfield[e+i-1][t+j-1]=1}}}}function move(e,t,n){if(placeTetromino(e,x+t,y+n)){x=x+t;y=y+n}drawTetromino()}function placeNext(){x=5;y=0;tile=next_tile;shape=next_shape;shape_color=next_color;next_tile=tiles[Math.floor(Math.random()*tiles.length)];next_shape=next_tile.template;next_color=next_tile.color;if(placeTetromino(shape,x,y)){ctx.clearRect(0,0,canvas_width,canvas_height);refresh(x,y,shape,shape_color)}else{gameover=true}}function main(){if(!gameover){moveDown();canMove=true;ctx.clearRect(0,0,canvas_width,canvas_height);refresh(x,y,shape,shape_color)}else{alert("Game Over");console.log("Game Over")}}function Timer(){if(!gameover){timerHelper=setTimeout(Timer,counter);main()}else if(ispaused){timerHelper=setTimeout(Timer,counter)}else{main();console.log("gameover")}}function init(){clearTimeout(timerHelper);x=4;y=0;score=0;if(!localStorage.high){localStorage.high=0}counter=500;gameover=false;tile=tiles[Math.floor(Math.random()*tiles.length)];shape=tile.template;next_tile=tiles[Math.floor(Math.random()*tiles.length)];next_shape=next_tile.template;next_color=next_tile.color;shape_color=tile.color;initializeGameField();timerHelper=setTimeout(Timer,counter)}var ctx=$("canvas")[0].getContext("2d");var gameover=false;var canvas_width=800;var canvas_height=800;var gamefield_width=340;var gamefield=[];var binfield=[];var pixel_size=gamefield_width/10;var gamefield_height=pixel_size*20;var fontSize=Math.floor(.75*pixel_size);var line_padding=pixel_size/7;var score=0;var highscore;var x=4;var y=0;var O={template:[[0,0,0,0],[0,1,1,0],[0,1,1,0],[0,0,0,0]],color:"#16a085"};var I={template:[[0,1,0,0],[0,1,0,0],[0,1,0,0],[0,1,0,0]],color:"#27ae60"};var Z={template:[[0,0,0,0],[0,1,1,0],[0,0,1,1],[0,0,0,0]],color:"#8e44ad"};var S={template:[[0,0,0,0],[0,0,1,1],[0,1,1,0],[0,0,0,0]],color:"#f39c12"};var T={template:[[0,0,0,0],[0,1,1,1],[0,0,1,0],[0,0,0,0]],color:"#d35400"};var J={template:[[0,0,0,0],[0,1,1,1],[0,0,0,1],[0,0,0,0]],color:"#2980b9"};var L={template:[[0,0,0,1],[0,1,1,1],[0,0,0,0],[0,0,0,0]],color:"#c0392b"};var bound={template:[[1,1,1,1],[1,1,1,1],[1,1,1,1],[1,1,1,1]],color:"#FF00FF"};var tiles=[O,I,Z,S,T,J,L];var Ocolor="#16a085";var Icolor="#27ae60";var Zcolor="#8e44ad";var Scolor="#f39c12";var Tcolor="#d35400";var Jcolor="#2980b9";var Lcolor="#c0392b";var tile=tiles[Math.floor(Math.random()*tiles.length)];var shape=tile.template;var next_tile=tiles[Math.floor(Math.random()*tiles.length)];var next_shape=next_tile.template;var next_color=next_tile.color;var shape_color=tile.color;$("canvas").css("background-color","rgba(158, 167, 184, 0.2)");initializeGameField();$(document).ready(function(){function r(){e.attr("width",$(n).width());e.attr("height",2*$(n).width());canvas_width=$(n).width();canvas_height=2*canvas_width;if(canvas_width<700){line_padding=canvas_width/138;pixel_size=(canvas_width-12*line_padding)/18;gamefield_width=pixel_size*10;gamefield_height=pixel_size*20;fontSize=Math.floor(.75*pixel_size);$("p").text("Swipe left, right, and down to move. Swipe up to rotate. Tap to pause. Hold to reset.");$("#my_popup").text("Tap to Resume")}canvas_height=gamefield_height+4*line_padding;console.log("pixelsize: ",pixel_size);console.log("gheight: ",gamefield_height);console.log("gwidth: ",gamefield_width);console.log("cheight: ",canvas_height);console.log("cwidth: ",canvas_width)}$("#my_popup").popup({backgroundactive:true});var e=$("#board");var t=e.get(0).getContext("2d");var n=$(e).parent();$(window).resize(r);r()});var x=4;var y=0;var tile=tiles[Math.floor(Math.random()*tiles.length)];var shape=tile.template;var next_tile=tiles[Math.floor(Math.random()*tiles.length)];var next_shape=next_tile.template;var next_color=next_tile.color;var shape_color=tile.color;refresh(x,y,shape,shape_color);$(document).on("touchmove",function(e){e.preventDefault()});(function(e){e.fn.nodoubletapzoom=function(){e(this).bind("touchstart",function(n){var r=n.timeStamp,i=e(this).data("lastTouch")||r,s=r-i,o=n.originalEvent.touches.length;e(this).data("lastTouch",r);if(!s||s>500||o>1)return;n.preventDefault();e(this).trigger("click").trigger("click")})}})(jQuery);var timeout=0;var thresh=20;setInterval(function(){timeout++},5);var myElement=document.getElementById("myElement");var mc=new Hammer(myElement);var ispaused=false;mc.get("pan").set({direction:Hammer.DIRECTION_ALL});mc.get("swipe").set({direction:Hammer.DIRECTION_ALL});mc.get("pan").set({threshold:10});var canMove;mc.on("press",function(e){var t=confirm("Reset?");if(t==true){init()}});mc.on("panleft",function(e){if(placeTetromino(shape,x-1,y)&&timeout>thresh){x--;timeout=0;ctx.clearRect(0,0,canvas_width,canvas_height);refresh(x,y,shape,shape_color)}});mc.on("panright",function(e){if(placeTetromino(shape,x+1,y)&&timeout>thresh){x++;timeout=0;ctx.clearRect(0,0,canvas_width,canvas_height);refresh(x,y,shape,shape_color)}});mc.on("pandown",function(e){if(placeTetromino(shape,x,y+1)&&timeout>thresh){y++;ctx.clearRect(0,0,canvas_width,canvas_height);refresh(x,y,shape,shape_color)}});mc.on("panup",function(e){if(placeTetromino(rotate(shape,1),x,y)&&canMove){shape=rotate(shape,1);canMove=false;ctx.clearRect(0,0,canvas_width,canvas_height);refresh(x,y,shape,shape_color)}});mc.on("tap",function(e){pause()});var curcounter;$(document).keydown(function(e){switch(e.which){case 37:if(placeTetromino(shape,x-1,y)){x--}break;case 38:if(placeTetromino(rotate(shape,1),x,y)){shape=rotate(shape,1)}break;case 39:if(placeTetromino(shape,x+1,y)){x++}break;case 40:if(placeTetromino(shape,x,y+1)){y++}break;case 78:init();break;case 32:while(placeTetromino(shape,x,y+1)){y++}break;case 80:pause();break;default:return}ctx.clearRect(0,0,canvas_width,canvas_height);refresh(x,y,shape,shape_color);e.preventDefault()});var moveDown=function(){if(placeTetromino(shape,x,y+1)){y++}else{lockTile(x,y,shape,shape_color);placeNext()}};var counter=500;var timerHelper;init()/**
 * Created by dmatt on 12/23/14.
 */
